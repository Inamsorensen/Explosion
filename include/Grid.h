#ifndef GRID
#define GRID

#include <vector>
#include <ngl/Vec3.h>
#include <iostream>

#include "Cell.h"


class Grid
{
public:
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Grid create instance
  //----------------------------------------------------------------------------------------------------------------------
  static Grid* createGrid(ngl::Vec3 _origin, float _gridSize, int _noCells);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Grid instance
  //----------------------------------------------------------------------------------------------------------------------
  static Grid* getGrid();

  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Get grid position
  //----------------------------------------------------------------------------------------------------------------------
  inline ngl::Vec3 getPosition() const {return m_origin;}
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Get grid size
  //----------------------------------------------------------------------------------------------------------------------
  inline float getGridSize() const {return m_gridSize;}
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Get cell size
  //----------------------------------------------------------------------------------------------------------------------
  inline float getCellSize() const {return m_cellSize;}

  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Setup velocity field
  //----------------------------------------------------------------------------------------------------------------------
  void setVelocityField(std::vector<ngl::Vec3> _velocityField);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Setup force field
  //----------------------------------------------------------------------------------------------------------------------
  void setForceField(std::vector<ngl::Vec3> _forceField);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Setup pressure field
  //----------------------------------------------------------------------------------------------------------------------
  void setPressureField(std::vector<float> _pressureField);

  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Update grid after time step _dt
  //----------------------------------------------------------------------------------------------------------------------
  void update(float _dt);

  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Get vector index from coordinates (i,j,k)
  //----------------------------------------------------------------------------------------------------------------------
  int getVectorIndex(int i, int j, int k);

  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Runge Kutta 2nd order integration for vec3
  //----------------------------------------------------------------------------------------------------------------------
  ngl::Vec3 RK2_integrator(ngl::Vec3 _u, ngl::Vec3 _du, float _dt);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Linear interpolation
  //----------------------------------------------------------------------------------------------------------------------
  float linearInterp(std::vector<float> *_function, float _x);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Trilinear interpolation for function
  //----------------------------------------------------------------------------------------------------------------------
  ngl::Vec3 trilinearInterpVec3(std::vector<ngl::Vec3> *_function, int _index0_X, int _index0_Y, int _index0_Z, int _index1_X, int _index1_Y, int _index1_Z, ngl::Vec3 _indexActual);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Trilinear interpolation for function
  //----------------------------------------------------------------------------------------------------------------------
  float trilinearInterpFloat(std::vector<float> *_function, int _index0_X, int _index0_Y, int _index0_Z, int _index1_X, int _index1_Y, int _index1_Z, ngl::Vec3 _indexActual);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Calculate divergence of a Vec3 field at index (i,j,k)
  //----------------------------------------------------------------------------------------------------------------------
  float calcDivergenceVec3(std::vector<ngl::Vec3> *_field, int _index_X, int _index_Y, int _index_Z);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Calculate divergence of a float field at index (i,j,k)
  //----------------------------------------------------------------------------------------------------------------------
  ngl::Vec3 calcDivergenceFloat(std::vector<float> *_field, int _index_X, int _index_Y, int _index_Z);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Linear system solver
  //----------------------------------------------------------------------------------------------------------------------
  void linearSystemSolve(std::vector<float> *result, std::vector<float> *_initField, std::vector<float> *_b, float _Aii, float _Aij, int _iterations);

  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Get velocity from field based on input position
  //----------------------------------------------------------------------------------------------------------------------
  ngl::Vec3 getVelocityFromField(ngl::Vec3 _particlePosition);

private:
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Grid constructor
  //----------------------------------------------------------------------------------------------------------------------
  Grid(ngl::Vec3 _origin, float _gridSize, int _noCells);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Grid instance pointer
  //----------------------------------------------------------------------------------------------------------------------
  static Grid* m_instance;

  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Origin (set as back lower corner)
  //----------------------------------------------------------------------------------------------------------------------
  ngl::Vec3 m_origin;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Length of one side of the grid (same for all directions as cube)
  //----------------------------------------------------------------------------------------------------------------------
  float m_gridSize;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Number of cells along one side (same in all direction, total number of cells=noCells^3)
  //----------------------------------------------------------------------------------------------------------------------
  int m_noCells;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Length of one grid cell (again cubic so same in all directions)
  //----------------------------------------------------------------------------------------------------------------------
  float m_cellSize;

  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Old velocity field
  //----------------------------------------------------------------------------------------------------------------------
  std::vector<ngl::Vec3> m_oldVelocityField;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief New velocity field
  //----------------------------------------------------------------------------------------------------------------------
  std::vector<ngl::Vec3> m_newVelocityField;

  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Force field
  //----------------------------------------------------------------------------------------------------------------------
  std::vector<ngl::Vec3> m_forceField;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Pressure field - unsure if this is needed
  //----------------------------------------------------------------------------------------------------------------------
  std::vector<float> m_pressureField;

  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Temporarily store Vec3 field
  //----------------------------------------------------------------------------------------------------------------------
  std::vector<ngl::Vec3> m_storeFieldVec3;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Temporarily store float field
  //----------------------------------------------------------------------------------------------------------------------
  std::vector<float> m_storeFieldFloat;

  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Store b for calculating projection
  //----------------------------------------------------------------------------------------------------------------------
  std::vector<float> m_storeB;
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Store A for calculating projection
  //----------------------------------------------------------------------------------------------------------------------
  std::vector<float> m_storeA;


  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Set boundary values for _vec3Field equal to the nearest neighbour cell
  //----------------------------------------------------------------------------------------------------------------------
  void setBoundaryValuesVec3(std::vector<ngl::Vec3> *_vec3Field);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Set boundary values for _floatField equal to the nearest neighbour cell
  //----------------------------------------------------------------------------------------------------------------------
  void setBoundaryValuesFloat(std::vector<float> *_floatField);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Set boundary velocity values to zero in direction of boundary normal
  //----------------------------------------------------------------------------------------------------------------------
  void setBoundaryVelocity();

  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Swap old and new fields
  //----------------------------------------------------------------------------------------------------------------------
  void swap();
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Update velocity field
  //----------------------------------------------------------------------------------------------------------------------
  void updateVelocityField(float _dt);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Step1: Add force
  //----------------------------------------------------------------------------------------------------------------------
  void addForce(float _dt);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Step2: Advect
  //----------------------------------------------------------------------------------------------------------------------
  void advect(float _dt);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Step3: Diffuse
  //----------------------------------------------------------------------------------------------------------------------
  void diffuse(float _dt);
  //----------------------------------------------------------------------------------------------------------------------
  /// @brief Step4: Project
  //----------------------------------------------------------------------------------------------------------------------
  void project();
  
};

#endif //GRID
